[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Drawdown Risk: Measurement, Prediction, and Mitigation",
    "section": "",
    "text": "Drawdowns — sustained declines from prior peaks — are a central measure of investment risk. They capture not only the size of losses but also their duration and the psychological and liquidity pressures they impose on market participants. While volatility remains the industry’s standard risk metric, drawdowns often determine actual investor behavior, influencing capital withdrawals, mandate breaches, and risk appetite.\nThis study examines drawdown risk through three complementary lenses:\n\nMechanics and measurement — formal definitions of maximum drawdown (MDD), average drawdown, and time under water, along with their statistical properties under different return-generating processes.\nPrediction and early warnings — the potential to forecast elevated drawdown risk using tools from both quantitative finance (e.g., correlation spikes, regime-switching probabilities, LPPL bubble detection) and market theory (e.g., Soros’s reflexivity, Mandelbrot’s multifractal markets).\nMitigation strategies — evaluating the performance of stop-loss rules, momentum-based overlays, and explicit hedges such as VIX futures and protective options.\n\nA central theme is the connection between stop-loss rules and momentum trading. A trailing stop that re-enters only above the prior peak inherently captures part of a time-series momentum strategy: it cuts risk when recent returns are negative and adds exposure when trend resumes. This link suggests that the efficacy of stop-losses will vary with the degree of return autocorrelation and the persistence of regimes — a hypothesis we test both in simulations and on historical data.\nStop-losses are not the only path to drawdown control. We compare them with explicit hedging strategies, including: - Volatility hedges: buying VIX futures or calls when early-warning indicators trigger. - Tail hedges: purchasing out-of-the-money index puts or put spreads to cap downside. - Dynamic allocation shifts: moving capital to low-volatility or uncorrelated assets in high-risk regimes.\nOur empirical analysis spans the S&P 500, US 10-year Treasury notes, and Bitcoin — assets with distinct volatility, correlation, and drawdown profiles. Simulation studies use AR(1), regime-switching, and stochastic volatility models to explore a wide parameter space and quantify expected performance differences across strategies.\nKey takeaways (preview): - Stop-loss effectiveness is conditional: they tend to improve risk-adjusted returns when returns exhibit positive serial correlation and regimes persist, but can hurt performance in mean-reverting markets. - Hedges offer complementary protection: while they often cost carry in normal markets, they can sharply reduce maximum drawdown and time under water when timed with credible early-warning signals. - Integrated approaches dominate: blending signal-driven stop-loss logic with targeted hedging yields better drawdown control per unit of performance drag than either technique alone.\nThis report proceeds from measurement to prediction to mitigation, grounding each step in both simulation and real-world data. By the conclusion, we present a framework for active drawdown management that integrates statistical signals, behavioral insights, and cost-aware strategy design.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Executive Summary</span>"
    ]
  },
  {
    "objectID": "sections/01_definitions.html",
    "href": "sections/01_definitions.html",
    "title": "2  Definitions and Measurement",
    "section": "",
    "text": "2.1 Why definitions matter\nConsistent drawdown metrics allow fair comparison across strategies and time periods. While Maximum Drawdown (MDD) is common, it captures only the single worst episode. Complementary measures like Average Drawdown (AvgDD), Time Under Water (TUW), Ulcer Index (UI), and Recovery Time help characterize the shape and persistence of losses.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Definitions and Measurement</span>"
    ]
  },
  {
    "objectID": "sections/01_definitions.html#key-metrics-formulas",
    "href": "sections/01_definitions.html#key-metrics-formulas",
    "title": "2  Definitions and Measurement",
    "section": "2.2 Key metrics & formulas",
    "text": "2.2 Key metrics & formulas\n\n2.2.1 Maximum Drawdown (MDD)\nDefinition: largest peak-to-trough loss.\n\\[\n\\mathrm{MDD} = \\min_t\\left(\\frac{P_t}{\\max_{\\tau \\le t} P_\\tau}-1\\right)\n\\]\n\n\n2.2.2 Average Drawdown (AvgDD)\nDefinition: mean depth across all drawdowns.\n\\[\n\\mathrm{AvgDD} = \\frac{1}{N_{\\text{dd}}}\\sum_{i=1}^{N_{\\text{dd}}}\\left(\\frac{P_{\\text{trough},i}}{P_{\\text{peak},i}}-1\\right)\n\\]\n\n\n2.2.3 Time Under Water (TUW)\nDefinition: average duration from a peak to full recovery.\n\\[\n\\mathrm{TUW} = \\frac{1}{N_{\\text{dd}}}\\sum_{i=1}^{N_{\\text{dd}}}\\left(t_{\\text{rec},i}-t_{\\text{peak},i}\\right)\n\\]\n\n\n2.2.4 Ulcer Index (UI)\nDefinition: RMS of percentage drawdowns (emphasizes persistent pain).\n\\[\n\\mathrm{UI} = \\sqrt{\\frac{1}{T}\\sum_{t=1}^T \\left(100\\times \\min\\left(0,\\frac{P_t}{\\max_{\\tau\\le t}P_\\tau}-1\\right)\\right)^2}\n\\]\n\n\n2.2.5 Recovery Time\nDefinition: longest time from a peak to its recovery.\n\\[\n\\max_i \\left(t_{\\text{rec},i}-t_{\\text{peak},i}\\right)\n\\]",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Definitions and Measurement</span>"
    ]
  },
  {
    "objectID": "sections/01_definitions.html#spy-example-downloaded-with-yfinance",
    "href": "sections/01_definitions.html#spy-example-downloaded-with-yfinance",
    "title": "2  Definitions and Measurement",
    "section": "2.3 SPY example (downloaded with yfinance)",
    "text": "2.3 SPY example (downloaded with yfinance)\n\nimport pandas as pd, numpy as np, matplotlib.pyplot as plt\nimport yfinance as yf\nfrom datetime import datetime\n\nspy = yf.download(\"SPY\", start=\"2000-01-01\", auto_adjust=True, progress=False)[\"Close\"].squeeze().asfreq(\"B\").ffill()\nrets = spy.pct_change().dropna()\nwealth = (1+rets).cumprod()\ndd = wealth/wealth.cummax() - 1\n\n# Identify drawdown episodes for AvgDD and TUW\npeaks = wealth.cummax()\nin_dd = dd &lt; 0\n# Episode IDs increment when leaving water and re-entering\nepisode_id = ( (~in_dd).astype(int).diff() == -1 ).cumsum()\nepisode_id = episode_id.where(in_dd, np.nan).ffill()\n\ndraws = []\nif episode_id.notna().any():\n    for eid, grp in wealth.groupby(episode_id.dropna()):\n        # grp spans underwater segment including starting day after a peak\n        depth = (grp/grp.cummax() - 1).min()\n        # Recovery time: from peak to first recovery beyond that peak\n        start_idx = grp.index[0]\n        peak_level = peaks.loc[start_idx]\n        # find recovery\n        after = wealth.loc[start_idx:]\n        rec_idx = after[after &gt;= peak_level].index.min()\n        if pd.isna(rec_idx):\n            rec_days = np.nan\n        else:\n            rec_days = (rec_idx - start_idx).days\n        draws.append((depth, rec_days))\n\navgdd = float(np.nanmean([d for d,_ in draws])) if draws else np.nan\ntuw = float(np.nanmean([u for _,u in draws])) if draws else np.nan\nrecovery_time = float(np.nanmax([u for _,u in draws])) if draws else np.nan\n\nmdd = float(dd.min())\nvol = float(rets.std()*np.sqrt(252))\ncagr = float((wealth.iloc[-1]/wealth.iloc[0])**(252/len(wealth))-1)\nui = float(np.sqrt(( (100*np.minimum(0, dd)).pow(2) ).mean()))\n\ntbl = pd.DataFrame({\n    \"CAGR\":[cagr],\n    \"Vol\":[vol],\n    \"Sharpe\":[cagr/vol if vol else np.nan],\n    \"MDD\":[mdd],\n    \"AvgDD\":[avgdd],\n    \"TUW_days\":[tuw],\n    \"RecoveryTime_days\":[recovery_time],\n    \"UlcerIndex\":[ui]\n})\ndisplay(tbl.round(4))\nimport os\nos.makedirs(\"figures\", exist_ok=True)\ntbl.to_csv(\"figures/spy_drawdown_metrics.csv\", index=False)\nprint(\"Saved to figures/spy_drawdown_metrics.csv\")\n\n\n\n\n\n\n\n\nCAGR\nVol\nSharpe\nMDD\nAvgDD\nTUW_days\nRecoveryTime_days\nUlcerIndex\n\n\n\n\n0\n0.0772\n0.1914\n0.4035\n-0.5519\n-0.017\n31.1618\n2404.0\n16.4171\n\n\n\n\n\n\n\nSaved to figures/spy_drawdown_metrics.csv\n\n\n\n# Quick plots\nplt.figure(); wealth.plot(title=\"SPY Wealth (2000-)\"); plt.tight_layout(); plt.show()\nplt.figure(); dd.plot(title=\"SPY Drawdown (2000-)\"); plt.tight_layout(); plt.show()",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Definitions and Measurement</span>"
    ]
  },
  {
    "objectID": "sections/01_definitions.html#practical-notes",
    "href": "sections/01_definitions.html#practical-notes",
    "title": "2  Definitions and Measurement",
    "section": "2.4 Practical notes",
    "text": "2.4 Practical notes\n\nMDD focuses on a single tail event; AvgDD and UI provide stability for optimization.\nTUW and Recovery Time reflect investor experience and liquidity needs.\nIn stop-loss testing, AvgDD and TUW often show larger improvements than MDD.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Definitions and Measurement</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html",
    "href": "sections/02_literature_review.html",
    "title": "3  Literature Review",
    "section": "",
    "text": "3.1 Drawdown mechanics and stylized models\nThis section surveys theory and evidence on drawdowns, their measurement, and interventions that aim to mitigate or anticipate them. We begin with analytical results for stylized processes, then review optimization under drawdown constraints, alternative risk measures, and the literature on early warnings and mitigation through stop-loss rules, momentum overlays, and hedging.\nEarly work characterizes the maximum drawdown (MDD) of continuous-time diffusions and discrete-time random walks. Closed-form or semi-closed-form results exist for Brownian motion and related processes, providing benchmarks for how often and how deeply paths fall below previous peaks purely by chance (Magdon-Ismail et al. 2004; Hadjiliadis and Vecer 2006). These models are invaluable as “nulls” against which more realistic, autocorrelated, or regime-switching processes can be compared.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#optimization-under-drawdown-constraints",
    "href": "sections/02_literature_review.html#optimization-under-drawdown-constraints",
    "title": "3  Literature Review",
    "section": "3.2 Optimization under drawdown constraints",
    "text": "3.2 Optimization under drawdown constraints\nA parallel literature designs policies that explicitly control drawdown rather than variance. Continuous-time portfolio problems with maximum-drawdown constraints yield optimal feedback rules that limit exposure after losses and scale back in after recoveries (Grossman and Zhou 1993). In discrete time, chance-constrained and dynamic-programming formulations treat drawdown as a state variable, often producing asymmetric risk-taking rules.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#risk-measures-beyond-variance",
    "href": "sections/02_literature_review.html#risk-measures-beyond-variance",
    "title": "3  Literature Review",
    "section": "3.3 Risk measures beyond variance",
    "text": "3.3 Risk measures beyond variance\nSeveral practical measures complement or replace volatility for portfolios whose investors are especially sensitive to underwater periods. Conditional Expected Drawdown (CED) and Conditional Drawdown at Risk (CDaR) generalize VaR/CVaR logic from returns to drawdowns, enabling optimization and attribution frameworks that penalize depth and duration of losses (Goldberg and Mahmoud 2014; Chekhlov, Uryasev, and Zabarankin 2005). Industry guidance likewise emphasizes “drawdown greeks” for understanding marginal contributions to risk (Harvey and Liu 2020).",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#probability-of-drawdown-and-feedback-control",
    "href": "sections/02_literature_review.html#probability-of-drawdown-and-feedback-control",
    "title": "3  Literature Review",
    "section": "3.4 Probability of drawdown and feedback control",
    "text": "3.4 Probability of drawdown and feedback control\nStochastic-control research analyzes the probability of breaching a given drawdown level and derives strategies that minimize it in diffusion settings (Angoshtari, Bayraktar, and Young 2015). In a related spirit, drawdown-modulated feedback adaptively scales positions based on current drawdown state, formalizing intuitive “pain-based” sizing rules (Hsieh and Barmish 2017).",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#predicting-large-drawdowns-bubbles-and-criticality",
    "href": "sections/02_literature_review.html#predicting-large-drawdowns-bubbles-and-criticality",
    "title": "3  Literature Review",
    "section": "3.5 Predicting large drawdowns: bubbles and criticality",
    "text": "3.5 Predicting large drawdowns: bubbles and criticality\nThe LPPL literature models bubbles as phases of faster-than-exponential growth decorated by log-periodic oscillations, culminating in a critical time \\(t_c\\) when crash risk is elevated (Sornette 2003; Johansen and Sornette 2000). Applications span indices, sectors, and single names, but calibration remains delicate—identifiability issues and overfitting are persistent challenges.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#when-to-start-worrying-during-a-drawdown",
    "href": "sections/02_literature_review.html#when-to-start-worrying-during-a-drawdown",
    "title": "3  Literature Review",
    "section": "3.6 When to start worrying during a drawdown",
    "text": "3.6 When to start worrying during a drawdown\nCloser to the practitioner’s perspective, Rej, Seager, and Bouchaud (2017) analyze the distribution of drawdown lengths and depths under realistic return processes and propose alarm thresholds for when a running drawdown becomes statistically unusual. This helps distinguish expected drawdowns from anomalous events that may warrant de-risking or hedging.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#stop-loss-rules-in-theory-and-practice",
    "href": "sections/02_literature_review.html#stop-loss-rules-in-theory-and-practice",
    "title": "3  Literature Review",
    "section": "3.7 Stop-loss rules in theory and practice",
    "text": "3.7 Stop-loss rules in theory and practice\nA substantial literature evaluates stop-loss rules—both fixed-percentage and trailing—under different data-generating processes and cost structures. Kaminski and Lo (2014) show that stops can improve risk-adjusted performance when returns display positive serial correlation and regime persistence, but often underperform buy-and-hold in mean-reverting markets or with high trading costs. Lo and Remorov (2017) extend this to regime-switching models with transaction costs.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#the-triple-penance-and-behavioral-reality-of-stops",
    "href": "sections/02_literature_review.html#the-triple-penance-and-behavioral-reality-of-stops",
    "title": "3  Literature Review",
    "section": "3.8 The triple penance and behavioral reality of stops",
    "text": "3.8 The triple penance and behavioral reality of stops\nBeyond mean–variance trade-offs, stops impose triple costs: (i) realizing losses, (ii) risking missed rebounds, and (iii) increasing trading and tax frictions—especially when whipsaws are frequent (Bailey and Lopez de Prado 2014). This perspective helps explain why stops may reduce MDD but still disappoint investors if re-entry logic is weak.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#stops-momentum-and-reflexivity",
    "href": "sections/02_literature_review.html#stops-momentum-and-reflexivity",
    "title": "3  Literature Review",
    "section": "3.9 Stops, momentum, and reflexivity",
    "text": "3.9 Stops, momentum, and reflexivity\nTrailing stops that re-enter only after a prior peak mechanically embed a momentum filter: exposure is kept when trend is healthy and cut when it’s impaired, with re-risking contingent on trend resumption. This links stops to time-series momentum and moving-average rules, and to reflexivity in which losses tighten risk limits, reduce liquidity, and deepen trends.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#correlation-contagion-and-systemic-warnings",
    "href": "sections/02_literature_review.html#correlation-contagion-and-systemic-warnings",
    "title": "3  Literature Review",
    "section": "3.10 Correlation, contagion, and systemic warnings",
    "text": "3.10 Correlation, contagion, and systemic warnings\nLarge drawdowns often coincide with spikes in cross-asset correlations and concentration of variance in the first principal component; monitoring rolling eigenvalues of the correlation matrix can serve as a contemporaneous warning of systemic fragility (Conlon and Cotter 2010).",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/02_literature_review.html#from-warnings-to-action-hedging-and-overlays",
    "href": "sections/02_literature_review.html#from-warnings-to-action-hedging-and-overlays",
    "title": "3  Literature Review",
    "section": "3.11 From warnings to action: hedging and overlays",
    "text": "3.11 From warnings to action: hedging and overlays\nPredictive signals must tie to concrete actions. Broadly, there are two levers: (i) exposure control via stops or momentum overlays, and (ii) explicit hedges (e.g., VIX futures or index puts). The most promising results come from integrated policies that tie hedge intensity or stop thresholds to early-warning probabilities, while accounting for costs and whipsaws.\n\n\n\n\nAngoshtari, Bahman, Erhan Bayraktar, and Virginia R. Young. 2015. “Minimizing the Probability of Drawdown in Diffusion Models.” Stochastic Processes and Their Applications 125 (5): 1810–65.\n\n\nBailey, David H., and Marcos Lopez de Prado. 2014. “Stop-Loss Strategies, Serial Correlation, and the Triple Penance Rule.” Journal of Risk 17 (2): 91–113.\n\n\nChekhlov, Alexei, Stanislav Uryasev, and Roman Zabarankin. 2005. “Drawdown Measure in Portfolio Optimization.” International Journal of Theoretical and Applied Finance 8 (1): 13–58.\n\n\nConlon, Thomas, and John Cotter. 2010. “Cross-Market Linkages and Financial Contagion.” International Review of Financial Analysis 19 (3): 190–202.\n\n\nGoldberg, Lisa R., and Owais Mahmoud. 2014. “Drawdown: From Practice to Theory and Back Again.” Journal of Investment Strategies 3 (4): 29–46.\n\n\nGrossman, Sanford J., and Zhongquan Zhou. 1993. “Optimal Investment Strategies for Controlling Drawdowns.” Mathematical Finance 3 (3): 241–76.\n\n\nHadjiliadis, Olympia, and Jan Vecer. 2006. “Drawdowns and the Speed of Market Recovery.” Stochastic Processes and Their Applications.\n\n\nHarvey, Campbell R., and Yan Liu. 2020. “Drawdown: Measures, Risk and Mitigation.” Journal of Portfolio Management 46 (6): 28–39.\n\n\nHsieh, Chuangyin, and B. Ross Barmish. 2017. “On Drawdown-Modulated Feedback Control in Stock Trading.” Quantitative Finance 17 (3): 329–40.\n\n\nJohansen, Anders, and Didier Sornette. 2000. “Critical Crashes.” Risk 12 (1): 91–94.\n\n\nKaminski, Kathryn M., and Andrew W. Lo. 2014. “When Do Stop-Loss Rules Stop Losses?” Journal of Portfolio Management 40 (2): 45–61.\n\n\nLo, Andrew W., and Alexander Remorov. 2017. “Stop-Loss Strategies with Serial Correlation, Regime Switching, and Transactions Costs.” Journal of Portfolio Management 43 (2): 59–75.\n\n\nMagdon-Ismail, Malik, Amir F. Atiya, Ashraf Pratap, and Yaser S. Abu-Mostafa. 2004. “Maximum Drawdown Under Brownian Motion.” Risk.\n\n\nRej, Adam, Philip Seager, and Jean-Philippe Bouchaud. 2017. “You Are in a Drawdown. When Should You Start Worrying?” arXiv Preprint.\n\n\nSornette, Didier. 2003. Why Stock Markets Crash: Critical Events in Complex Financial Systems. Princeton University Press.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Literature Review</span>"
    ]
  },
  {
    "objectID": "sections/03_simulation_framework.html",
    "href": "sections/03_simulation_framework.html",
    "title": "4  Simulation Framework",
    "section": "",
    "text": "5 Simulation Framework\nWe simulate synthetic return paths to test drawdown-mitigation rules under controlled statistical environments. This enables us to:",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Simulation Framework</span>"
    ]
  },
  {
    "objectID": "sections/03_simulation_framework.html#ar1-process-with-trailing-stop-loss",
    "href": "sections/03_simulation_framework.html#ar1-process-with-trailing-stop-loss",
    "title": "4  Simulation Framework",
    "section": "5.1 AR(1) process with trailing stop-loss",
    "text": "5.1 AR(1) process with trailing stop-loss\nThe base process for log-returns is:\n\\[\nr_t = \\mu + \\rho (r_{t-1} - \\mu) + \\sigma \\varepsilon_t, \\quad \\varepsilon_t \\sim \\mathcal{N}(0,1)\n\\]\n\n\\(\\mu\\): daily drift\n\n\\(\\rho\\): lag-1 autocorrelation coefficient\n\n\\(\\sigma\\): daily volatility\n\nWe parameterize \\(\\mu\\) and \\(\\sigma\\) in annualized terms for interpretability.\n\nThe stop-loss rule is:\n\nTrigger: 5% trailing peak-to-trough decline in portfolio value.\nExit: Go to cash immediately upon breach.\nRe-entry: Only when price exceeds the prior peak (“stop-out peak”), ensuring no premature re-risking.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Simulation Framework</span>"
    ]
  },
  {
    "objectID": "sections/03_simulation_framework.html#implementation",
    "href": "sections/03_simulation_framework.html#implementation",
    "title": "4  Simulation Framework",
    "section": "5.2 Implementation",
    "text": "5.2 Implementation\n\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\n\ndef simulate_ar1_paths(n_paths=100, n_days=252*5, mu_ann=0.0, sigma_ann=0.05, rho=0.0, seed=42):\n    np.random.seed(seed)\n    mu = mu_ann / 252\n    sigma = sigma_ann / np.sqrt(252)\n    rets = np.zeros((n_days, n_paths))\n    shocks = np.random.randn(n_days, n_paths)\n    for t in range(1, n_days):\n        rets[t] = mu + rho * (rets[t-1] - mu) + sigma * shocks[t]\n    return rets\n\ndef apply_trailing_stop(returns, stop=0.05):\n    \"\"\"returns: 1D array of daily returns\"\"\"\n    wealth = np.cumprod(1 + returns)\n    peak = np.maximum.accumulate(wealth)\n    in_market = np.ones(len(wealth), dtype=bool)\n    cash = 0.0\n    stop_peak = peak[0]\n    for t in range(1, len(wealth)):\n        if in_market[t-1]:\n            # Check stop breach\n            if (wealth[t] / peak[t] - 1) &lt;= -stop:\n                in_market[t] = False\n                cash = wealth[t]\n                stop_peak = peak[t]\n            else:\n                in_market[t] = True\n        else:\n            # Stay in cash until break above stop_peak\n            if wealth[t] &gt;= stop_peak:\n                in_market[t] = True\n                cash = 0.0\n            else:\n                in_market[t] = False\n    strat_wealth = np.ones(len(wealth))\n    strat_wealth[0] = 1.0\n    in_cash = False\n    for t in range(1, len(wealth)):\n        if in_market[t]:\n            strat_wealth[t] = strat_wealth[t-1] * (1 + returns[t])\n        else:\n            strat_wealth[t] = strat_wealth[t-1]\n    return strat_wealth\n\ndef metrics(wealth):\n    rets = pd.Series(wealth).pct_change().dropna()\n    vol = rets.std() * np.sqrt(252)\n    cagr = (wealth[-1]/wealth[0])**(252/len(wealth))-1\n    sharpe = cagr/vol if vol&gt;0 else np.nan\n    dd = wealth/np.maximum.accumulate(wealth) - 1\n    mdd = dd.min()\n    avgdd = dd[dd&lt;0].mean()\n    return dict(CAGR=cagr, Vol=vol, Sharpe=sharpe, MDD=mdd, AvgDD=avgdd)\n\n# Example: rho = 0.3, mu = 0\nrets = simulate_ar1_paths(n_paths=1, rho=0.3, mu_ann=0.0)\nrets = rets[:,0]\nwealth_bh = np.cumprod(1+rets)\nwealth_stop = apply_trailing_stop(rets)\n\n# Metrics\nprint(\"Buy & Hold:\", metrics(wealth_bh))\nprint(\"Stop-Loss:\", metrics(wealth_stop))\n\n# Plot\nplt.figure(figsize=(8,4))\nplt.plot(wealth_bh, label=\"Buy & Hold\")\nplt.plot(wealth_stop, label=\"5% Trailing Stop\")\nplt.title(\"Example Path — AR(1) ρ=0.3, μ=0\")\nplt.legend()\nplt.tight_layout()\nplt.show()\n\nBuy & Hold: {'CAGR': np.float64(0.04237321398912175), 'Vol': np.float64(0.05150267861021977), 'Sharpe': np.float64(0.8227380620299146), 'MDD': np.float64(-0.13412749497028176), 'AvgDD': np.float64(-0.049024746445191156)}\nStop-Loss: {'CAGR': np.float64(0.022248918103237925), 'Vol': np.float64(0.03398916770371736), 'Sharpe': np.float64(0.6545884941102745), 'MDD': np.float64(-0.06604965292696174), 'AvgDD': np.float64(-0.03989770367663479)}\n\n\n\n\n\nAR(1) simulation — Buy & Hold vs 5% trailing stop-loss",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Simulation Framework</span>"
    ]
  },
  {
    "objectID": "sections/03_simulation_framework.html#design-choices",
    "href": "sections/03_simulation_framework.html#design-choices",
    "title": "4  Simulation Framework",
    "section": "5.3 Design choices",
    "text": "5.3 Design choices\nFixed stop threshold: Here set at 5% to illustrate; later sweeps will show sensitivity.\nNo transaction costs: This isolates pure statistical effects; costs will be added in empirical sections.\nIn-sample vs out-of-sample: Since AR(1) parameters are known here, there’s no estimation error. This will not hold in real data.\nIn the next section, we will sweep \\(\\rho\\) from -0.5 to 0.5 and drifts from -10% to +10% annually, holding volatility constant, to see when stops help/hurt on each performance dimension.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Simulation Framework</span>"
    ]
  },
  {
    "objectID": "sections/04_empirical_measurement.html",
    "href": "sections/04_empirical_measurement.html",
    "title": "5  Empirical Measurement",
    "section": "",
    "text": "We fetch daily data with yfinance and compute: returns, wealth & drawdowns, rolling μ/σ/ρ, and a summary table for SPY, IEF, and BTC.\n\nimport pandas as pd, numpy as np, matplotlib.pyplot as plt\nfrom scripts.empirical_data import load_prices_yf, pct_returns, wealth_series, drawdown_series, rolling_stats, summary_metrics\n\ntickers = {\n    \"S&P 500 (SPY adj close)\": \"SPY\",\n    \"US 7-10Y Treasury (IEF)\": \"IEF\",\n    \"Bitcoin (BTC-USD)\": \"BTC-USD\",\n    \"VIX Index (proxy only)\": \"^VIX\"\n}\n\nprices = {}\nfor label, t in tickers.items():\n    try:\n        prices[label] = load_prices_yf(t, start=\"2003-01-01\")\n    except Exception as e:\n        print(f\"Skipping {label}: {e}\")\n\nrets = {k: pct_returns(v) for k, v in prices.items() if v is not None}\nsumm = {k: summary_metrics(r) for k, r in rets.items() if k != \"VIX Index (proxy only)\"}\npd.DataFrame(summ).T\n\nTicker            SPY\nDate                 \n2003-01-02  59.986362\n2003-01-03  60.170807\n2003-01-06  61.231281\n2003-01-07  61.079792\n2003-01-08  60.197132\nTicker            IEF\nDate                 \n2003-01-02  44.324108\n2003-01-03  44.397266\n2003-01-06  44.287514\n2003-01-07  44.428646\n2003-01-08  44.533195\nTicker         BTC-USD\nDate                  \n2014-09-17  457.334015\n2014-09-18  424.440002\n2014-09-19  394.795990\n2014-09-20  408.903992\n2014-09-21  398.821014\nTicker           ^VIX\nDate                 \n2003-01-02  25.389999\n2003-01-03  24.680000\n2003-01-06  24.910000\n2003-01-07  25.129999\n2003-01-08  25.530001\n\n\n\n\n\n\n\n\n\nCAGR\nVol\nSharpe\nMDD\nAvgDD\nTUW_days\n\n\n\n\nS&P 500 (SPY adj close)\n0.106012\n0.184301\n0.575212\n-0.551894\n-0.078635\n5177.0\n\n\nUS 7-10Y Treasury (IEF)\n0.033232\n0.067210\n0.494447\n-0.239248\n-0.054489\n5596.0\n\n\nBitcoin (BTC-USD)\n0.647683\n0.663650\n0.975942\n-0.830363\n-0.370045\n2695.0\n\n\n\n\n\n\n\n\n# Wealth and drawdowns\nfor label in [\"S&P 500 (SPY adj close)\", \"US 7-10Y Treasury (IEF)\", \"Bitcoin (BTC-USD)\"]:\n    if label not in rets: \n        continue\n    r = rets[label]\n    W = wealth_series(r)\n    dd = drawdown_series(r)\n    plt.figure(); W.plot(title=f\"Wealth — {label}\"); plt.tight_layout(); plt.show()\n    plt.figure(); dd.plot(title=f\"Drawdown — {label}\"); plt.tight_layout(); plt.show()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n# Rolling stats (S&P 500 example)\nlabel = \"S&P 500 (SPY adj close)\"\nif label in rets:\n    r = rets[label]\n    roll = rolling_stats(r, w_short=20, w_long=126)\n    plt.figure(); roll[\"mu_ann\"].plot(title=\"S&P 500 — Rolling Annualized Mean (126d)\"); plt.tight_layout(); plt.show()\n    plt.figure(); roll[\"vol_ann\"].plot(title=\"S&P 500 — Rolling Annualized Vol (126d)\"); plt.tight_layout(); plt.show()\n    plt.figure(); roll[\"rho1\"].plot(title=\"S&P 500 — Rolling AC(1) (126d)\"); plt.tight_layout(); plt.show()\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nfrom scripts.reporting import compare_strategies, save_table\nrets_named = {k: v for k, v in rets.items() if k in [\"S&P 500 (SPY adj close)\", \"US 7-10Y Treasury (IEF)\", \"Bitcoin (BTC-USD)\"]}\nif len(rets_named) &gt;= 1:\n    table = compare_strategies(rets_named)\n    display(table)\n    out_csv = save_table(table, \"figures/empirical_summary.csv\")\n    print(\"Saved summary CSV to:\", out_csv)\n\n\n\n\n\n\n\n\nCAGR\nVol\nSharpe\nMDD\nAvgDD\nTUW_days\n\n\nStrategy\n\n\n\n\n\n\n\n\n\n\nS&P 500 (SPY adj close)\n0.106012\n0.184301\n0.575212\n-0.551894\n-0.078635\n5177\n\n\nUS 7-10Y Treasury (IEF)\n0.033232\n0.067210\n0.494447\n-0.239248\n-0.054489\n5596\n\n\nBitcoin (BTC-USD)\n0.647683\n0.663650\n0.975942\n-0.830363\n-0.370045\n2695\n\n\n\n\n\nEmpirical summary exported to CSV\n\n\nSaved summary CSV to: figures/empirical_summary.csv",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Empirical Measurement</span>"
    ]
  },
  {
    "objectID": "sections/05_early_warnings.html",
    "href": "sections/05_early_warnings.html",
    "title": "6  Early Warning Signals",
    "section": "",
    "text": "We build features from price-only data (volatility ratio, drawdown slope, SMA deviation, and a lightweight LPPL risk score) and predict whether a large drawdown occurs within a forward horizon.\n\nimport pandas as pd, numpy as np, matplotlib.pyplot as plt\nfrom sklearn.linear_model import LogisticRegression\nfrom sklearn.metrics import roc_auc_score, roc_curve, classification_report\nfrom scripts.empirical_data import load_prices_yf\nfrom scripts.early_warnings import build_ews_features_from_prices, label_future_drawdown_from_prices\n\nspy = load_prices_yf(\"SPY\", start=\"2000-01-01\")\nX = build_ews_features_from_prices(spy)\ny = label_future_drawdown_from_prices(spy, horizon=60, threshold=-0.15)\n\ndf = pd.concat([X, y], axis=1).dropna()\nsplit = int(len(df)*0.7)\nX_train, X_test = df.iloc[:split, :-1], df.iloc[split:, :-1]\ny_train, y_test = df.iloc[:split, -1], df.iloc[split:, -1]\n\nclf = LogisticRegression(max_iter=2000)\nclf.fit(X_train, y_train)\nproba = clf.predict_proba(X_test)[:,1]\nauc = roc_auc_score(y_test, proba)\nprint(f\"AUC: {auc:.3f}\")\n\n# ROC\nfpr, tpr, _ = roc_curve(y_test, proba)\nplt.figure(); plt.plot(fpr, tpr, label=f\"AUC={auc:.3f}\"); plt.plot([0,1],[0,1],'k--')\nplt.xlabel(\"False Positive Rate\"); plt.ylabel(\"True Positive Rate\")\nplt.title(\"ROC — EWS with LPPL (SPY)\"); plt.legend(); plt.tight_layout(); plt.show()\n\n# Feature importances (coef magnitude)\nimp = pd.Series(clf.coef_[0], index=X.columns).sort_values(key=np.abs, ascending=False)\nprint(\"Top features:\\n\", imp.head(10))\n\n# Classification report at 0.5 threshold\npred = (proba &gt;= 0.5).astype(int)\nprint(classification_report(y_test, pred, digits=3))\n\n# Export predictions\nout = pd.DataFrame({\"proba\": proba, \"y_test\": y_test.values}, index=y_test.index)\nout.to_csv(\"figures/ews_lppl_spy_predictions.csv\")\nprint(\"Saved predictions to figures/ews_lppl_spy_predictions.csv\")\n\nTicker            SPY\nDate                 \n2000-01-03  92.142509\n2000-01-04  88.539200\n2000-01-05  88.697571\n2000-01-06  87.272095\n2000-01-07  92.340523\nAUC: 0.636\n\n\n\n\n\nSPY early-warning model with LPPL risk\n\n\n\n\nTop features:\n sma_dev     -10.152553\nvol_ratio     0.398983\nlppl_risk    -0.086134\ndd_slope      0.080557\ndtype: float64\n              precision    recall  f1-score   support\n\n         0.0      0.886     0.997     0.938      1742\n         1.0      0.143     0.004     0.009       225\n\n    accuracy                          0.883      1967\n   macro avg      0.514     0.501     0.473      1967\nweighted avg      0.801     0.883     0.832      1967\n\nSaved predictions to figures/ews_lppl_spy_predictions.csv",
    "crumbs": [
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Early Warning Signals</span>"
    ]
  },
  {
    "objectID": "sections/06_stoploss_and_hedging.html",
    "href": "sections/06_stoploss_and_hedging.html",
    "title": "7  Stop-Loss, Momentum, and Hedging",
    "section": "",
    "text": "7.1 Demos\nimport numpy as np, pandas as pd, matplotlib.pyplot as plt\nfrom scripts.hedging import rolling_put_hedge, vix_overlay\nfrom scripts.simulations import simulate_ar1\n\nprice = simulate_ar1(mu_ann=0.00, rho=0.2, sigma_ann=0.15, years=3, seed=123)\nrets = price.pct_change().dropna()\n\nhedged, roll_flags = rolling_put_hedge(price, moneyness=0.95, tenor_days=21, iv_annual=0.20)\n\nwealth_asset = (1+rets).cumprod()\nwealth_hedged = (1+hedged).cumprod()\n\nplt.figure(); wealth_asset.plot(label=\"Asset\"); wealth_hedged.plot(label=\"Put-hedged\")\nplt.title(\"Wealth: Asset vs Rolling 95% Put Hedge (toy)\"); plt.legend(); plt.tight_layout(); plt.show()\n\nvix_proxy = -rets * 3.0\ntrigger = rets.rolling(10).std().shift(1) &gt; rets.rolling(60).std().shift(1)\nvix_ov = vix_overlay(rets, vix_proxy, trigger, hedge_weight=0.2).dropna()\nplt.figure(); (1+rets).cumprod().plot(label=\"Asset\"); (1+vix_ov).cumprod().plot(label=\"VIX overlay\")\nplt.title(\"Wealth: Asset vs VIX Overlay (toy)\"); plt.legend(); plt.tight_layout(); plt.show()\n\n\n\n\nIllustrative hedging overlays (toy examples)\nimport numpy as np, pandas as pd, matplotlib.pyplot as plt\nfrom scripts.simulations import simulate_ar1\nfrom scripts.stoploss import apply_trailing_stop, apply_costs\n\nprice = simulate_ar1(mu_ann=0.04, rho=0.1, sigma_ann=0.15, years=5, seed=7)\nrets = price.pct_change().dropna()\n\nsl_rets, pos, trade, tovr = apply_trailing_stop(price, stop_pct=0.05, reenter_above_peak=True)\nsl_costed = apply_costs(sl_rets, trade, tovr, fixed_bps=1.0, slippage_bps=2.0, spread_bps=5.0)\n\nwealth_bh = (1+rets).cumprod()\nwealth_sl = (1+sl_rets).cumprod()\nwealth_sl_cost = (1+sl_costed).cumprod()\n\nplt.figure(); wealth_bh.plot(label=\"Buy & Hold\"); wealth_sl.plot(label=\"Stop 5% (no costs)\"); wealth_sl_cost.plot(label=\"Stop 5% (with costs)\")\nplt.title(\"Wealth with Stop-Loss and Transaction Costs (toy)\"); plt.legend(); plt.tight_layout(); plt.show()\n\n\n\n\nStop-loss with transaction costs (toy example)",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Stop-Loss, Momentum, and Hedging</span>"
    ]
  },
  {
    "objectID": "sections/06_stoploss_and_hedging.html#data-driven-hedge-example-vix-proxy",
    "href": "sections/06_stoploss_and_hedging.html#data-driven-hedge-example-vix-proxy",
    "title": "7  Stop-Loss, Momentum, and Hedging",
    "section": "7.2 Data-Driven Hedge Example (VIX proxy)",
    "text": "7.2 Data-Driven Hedge Example (VIX proxy)\n\nimport pandas as pd, numpy as np, matplotlib.pyplot as plt\nfrom scripts.empirical_data import load_prices_yf, pct_returns, wealth_series\nfrom scripts.hedging import vix_overlay\nfrom scripts.stoploss import apply_trailing_stop, apply_costs\n\nspy = load_prices_yf(\"SPY\", start=\"2006-01-01\")\nvix = load_prices_yf(\"^VIX\", start=\"2006-01-01\")\n\nr_spy = pct_returns(spy)\nr_vix = pct_returns(vix)\n\nvol_s = r_spy.rolling(20).std().shift(1)\nvol_l = r_spy.rolling(60).std().shift(1)\ntrigger = (vol_s &gt; vol_l).reindex_like(r_spy).fillna(False)\n\nsl_rets, pos, trade, tovr = apply_trailing_stop(spy, stop_pct=0.05, reenter_above_peak=True)\nsl_rets = sl_rets.reindex_like(r_spy).fillna(0.0)\nsl_costed = apply_costs(sl_rets, trade, tovr, fixed_bps=1.0, slippage_bps=2.0, spread_bps=5.0)\n\ncombo = vix_overlay(sl_costed, r_vix, trigger, hedge_weight=0.20).dropna()\n\nW_bh = wealth_series(r_spy)\nW_sl = wealth_series(sl_costed)\nW_combo = wealth_series(combo)\n\nplt.figure(); W_bh.plot(label=\"Buy & Hold (SPY)\"); W_sl.plot(label=\"Stop 5% (with costs)\"); W_combo.plot(label=\"Stop 5% + 20% VIX overlay\")\nplt.title(\"Wealth: SPY vs Stop-Loss vs Stop+VIX Overlay\"); plt.legend(); plt.tight_layout(); plt.show()\n\nTicker            SPY\nDate                 \n2006-01-03  87.964905\n2006-01-04  88.381485\n2006-01-05  88.437012\n2006-01-06  89.172966\n2006-01-09  89.402061\nTicker       ^VIX\nDate             \n2006-01-03  11.14\n2006-01-04  11.37\n2006-01-05  11.31\n2006-01-06  11.00\n2006-01-09  11.13\n\n\n\n\n\n\n\n\n\n\nfrom scripts.reporting import compare_strategies, save_table, save_figure\nfrom scripts.empirical_data import wealth_series\n\ncomparables = {\n    \"Buy & Hold (SPY)\": r_spy,\n    \"Stop 5% (with costs)\": sl_costed,\n    \"Stop 5% + 20% VIX overlay\": combo\n}\ntable = compare_strategies(comparables)\ndisplay(table)\n\ncsv_path = save_table(table, \"figures/spy_strategy_comparison.csv\")\nprint(\"Saved strategy metrics to:\", csv_path)\n\nplt.figure()\nwealth_series(r_spy).plot(label=\"Buy & Hold (SPY)\")\nwealth_series(sl_costed).plot(label=\"Stop 5% (with costs)\")\nwealth_series(combo).plot(label=\"Stop 5% + 20% VIX overlay\")\nplt.title(\"Wealth: SPY vs Stop-Loss vs Stop+VIX Overlay\"); plt.legend()\npng_path = save_figure(\"figures/spy_wealth_strategies.png\")\nprint(\"Saved figure to:\", png_path)\n\n\n\n\n\n\n\n\nCAGR\nVol\nSharpe\nMDD\nAvgDD\nTUW_days\n\n\nStrategy\n\n\n\n\n\n\n\n\n\n\nBuy & Hold (SPY)\n0.102128\n0.191638\n0.532921\n-0.551895\n-0.086492\n4492\n\n\nStop 5% (with costs)\n0.058013\n0.072148\n0.804086\n-0.087379\n-0.039357\n4738\n\n\nStop 5% + 20% VIX overlay\n0.025733\n0.179518\n0.143342\n-0.445388\n-0.168309\n5034\n\n\n\n\n\nSPY: Buy&Hold vs Stop vs Stop+VIX — metrics and exports\n\n\nSaved strategy metrics to: figures/spy_strategy_comparison.csv\nSaved figure to: figures/spy_wealth_strategies.png",
    "crumbs": [
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Stop-Loss, Momentum, and Hedging</span>"
    ]
  },
  {
    "objectID": "sections/07_results_synthesis.html",
    "href": "sections/07_results_synthesis.html",
    "title": "8  Results Synthesis",
    "section": "",
    "text": "(Write-up and comparison tables to be added.)",
    "crumbs": [
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Results Synthesis</span>"
    ]
  },
  {
    "objectID": "sections/08_appendices.html",
    "href": "sections/08_appendices.html",
    "title": "9  Appendices",
    "section": "",
    "text": "(Math notes, parameter grids, and full tables to be added.)",
    "crumbs": [
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Appendices</span>"
    ]
  }
]