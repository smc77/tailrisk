{
  "hash": "b6c2256e5af4b2fc27b24ab6423d649f",
  "result": {
    "engine": "jupyter",
    "markdown": "# Stop-Loss, Momentum, and Hedging\n\n## Demos\n\n::: {#hedge-examples .cell execution_count=1}\n``` {.python .cell-code}\nimport numpy as np, pandas as pd, matplotlib.pyplot as plt\nfrom scripts.hedging import rolling_put_hedge, vix_overlay\nfrom scripts.simulations import simulate_ar1\n\nprice = simulate_ar1(mu_ann=0.00, rho=0.2, sigma_ann=0.15, years=3, seed=123)\nrets = price.pct_change().dropna()\n\nhedged, roll_flags = rolling_put_hedge(price, moneyness=0.95, tenor_days=21, iv_annual=0.20)\n\nwealth_asset = (1+rets).cumprod()\nwealth_hedged = (1+hedged).cumprod()\n\nplt.figure(); wealth_asset.plot(label=\"Asset\"); wealth_hedged.plot(label=\"Put-hedged\")\nplt.title(\"Wealth: Asset vs Rolling 95% Put Hedge (toy)\"); plt.legend(); plt.tight_layout(); plt.show()\n\nvix_proxy = -rets * 3.0\ntrigger = rets.rolling(10).std().shift(1) > rets.rolling(60).std().shift(1)\nvix_ov = vix_overlay(rets, vix_proxy, trigger, hedge_weight=0.2).dropna()\nplt.figure(); (1+rets).cumprod().plot(label=\"Asset\"); (1+vix_ov).cumprod().plot(label=\"VIX overlay\")\nplt.title(\"Wealth: Asset vs VIX Overlay (toy)\"); plt.legend(); plt.tight_layout(); plt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Illustrative hedging overlays (toy examples)](06_stoploss_and_hedging_files/figure-pdf/hedge-examples-output-1.pdf){#hedge-examples-1 fig-pos='H'}\n:::\n\n::: {.cell-output .cell-output-display}\n![](06_stoploss_and_hedging_files/figure-pdf/hedge-examples-output-2.pdf){#hedge-examples-2 fig-pos='H'}\n:::\n:::\n\n\n::: {.cell execution_count=2}\n``` {.python .cell-code}\nimport numpy as np, pandas as pd, matplotlib.pyplot as plt\nfrom scripts.simulations import simulate_ar1\nfrom scripts.stoploss import apply_trailing_stop, apply_costs\n\nprice = simulate_ar1(mu_ann=0.04, rho=0.1, sigma_ann=0.15, years=5, seed=7)\nrets = price.pct_change().dropna()\n\nsl_rets, pos, trade, tovr = apply_trailing_stop(price, stop_pct=0.05, reenter_above_peak=True)\nsl_costed = apply_costs(sl_rets, trade, tovr, fixed_bps=1.0, slippage_bps=2.0, spread_bps=5.0)\n\nwealth_bh = (1+rets).cumprod()\nwealth_sl = (1+sl_rets).cumprod()\nwealth_sl_cost = (1+sl_costed).cumprod()\n\nplt.figure(); wealth_bh.plot(label=\"Buy & Hold\"); wealth_sl.plot(label=\"Stop 5% (no costs)\"); wealth_sl_cost.plot(label=\"Stop 5% (with costs)\")\nplt.title(\"Wealth with Stop-Loss and Transaction Costs (toy)\"); plt.legend(); plt.tight_layout(); plt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Stop-loss with transaction costs (toy example)](06_stoploss_and_hedging_files/figure-pdf/stoploss-with-costs-output-1.pdf){#stoploss-with-costs fig-pos='H'}\n:::\n:::\n\n\n## Data-Driven Hedge Example (VIX proxy)\n\n::: {.cell execution_count=3}\n``` {.python .cell-code}\nimport pandas as pd, numpy as np, matplotlib.pyplot as plt\nfrom scripts.empirical_data import load_prices_yf, pct_returns, wealth_series\nfrom scripts.hedging import vix_overlay\nfrom scripts.stoploss import apply_trailing_stop, apply_costs\n\nspy = load_prices_yf(\"SPY\", start=\"2006-01-01\")\nvix = load_prices_yf(\"^VIX\", start=\"2006-01-01\")\n\nr_spy = pct_returns(spy)\nr_vix = pct_returns(vix)\n\nvol_s = r_spy.rolling(20).std().shift(1)\nvol_l = r_spy.rolling(60).std().shift(1)\ntrigger = (vol_s > vol_l).reindex_like(r_spy).fillna(False)\n\nsl_rets, pos, trade, tovr = apply_trailing_stop(spy, stop_pct=0.05, reenter_above_peak=True)\nsl_rets = sl_rets.reindex_like(r_spy).fillna(0.0)\nsl_costed = apply_costs(sl_rets, trade, tovr, fixed_bps=1.0, slippage_bps=2.0, spread_bps=5.0)\n\ncombo = vix_overlay(sl_costed, r_vix, trigger, hedge_weight=0.20).dropna()\n\nW_bh = wealth_series(r_spy)\nW_sl = wealth_series(sl_costed)\nW_combo = wealth_series(combo)\n\nplt.figure(); W_bh.plot(label=\"Buy & Hold (SPY)\"); W_sl.plot(label=\"Stop 5% (with costs)\"); W_combo.plot(label=\"Stop 5% + 20% VIX overlay\")\nplt.title(\"Wealth: SPY vs Stop-Loss vs Stop+VIX Overlay\"); plt.legend(); plt.tight_layout(); plt.show()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nTicker            SPY\nDate                 \n2006-01-03  87.964905\n2006-01-04  88.381447\n2006-01-05  88.437012\n2006-01-06  89.172943\n2006-01-09  89.402100\nTicker       ^VIX\nDate             \n2006-01-03  11.14\n2006-01-04  11.37\n2006-01-05  11.31\n2006-01-06  11.00\n2006-01-09  11.13\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](06_stoploss_and_hedging_files/figure-pdf/cell-4-output-2.pdf){fig-pos='H'}\n:::\n:::\n\n\n::: {#strategy-comparison .cell execution_count=4}\n``` {.python .cell-code}\nfrom scripts.reporting import compare_strategies, save_table, save_figure\nfrom scripts.empirical_data import wealth_series\n\ncomparables = {\n    \"Buy & Hold (SPY)\": r_spy,\n    \"Stop 5% (with costs)\": sl_costed,\n    \"Stop 5% + 20% VIX overlay\": combo\n}\ntable = compare_strategies(comparables)\ndisplay(table)\n\ncsv_path = save_table(table, \"figures/spy_strategy_comparison.csv\")\nprint(\"Saved strategy metrics to:\", csv_path)\n\nplt.figure()\nwealth_series(r_spy).plot(label=\"Buy & Hold (SPY)\")\nwealth_series(sl_costed).plot(label=\"Stop 5% (with costs)\")\nwealth_series(combo).plot(label=\"Stop 5% + 20% VIX overlay\")\nplt.title(\"Wealth: SPY vs Stop-Loss vs Stop+VIX Overlay\"); plt.legend()\npng_path = save_figure(\"figures/spy_wealth_strategies.png\")\nprint(\"Saved figure to:\", png_path)\n```\n\n::: {#strategy-comparison-1 .cell-output .cell-output-display}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>CAGR</th>\n      <th>Vol</th>\n      <th>Sharpe</th>\n      <th>MDD</th>\n      <th>AvgDD</th>\n      <th>TUW_days</th>\n    </tr>\n    <tr>\n      <th>Strategy</th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>Buy &amp; Hold (SPY)</th>\n      <td>0.102128</td>\n      <td>0.191638</td>\n      <td>0.532922</td>\n      <td>-0.551895</td>\n      <td>-0.086434</td>\n      <td>4495</td>\n    </tr>\n    <tr>\n      <th>Stop 5% (with costs)</th>\n      <td>0.058013</td>\n      <td>0.072148</td>\n      <td>0.804087</td>\n      <td>-0.087379</td>\n      <td>-0.039348</td>\n      <td>4739</td>\n    </tr>\n    <tr>\n      <th>Stop 5% + 20% VIX overlay</th>\n      <td>0.025733</td>\n      <td>0.179518</td>\n      <td>0.143343</td>\n      <td>-0.445388</td>\n      <td>-0.168309</td>\n      <td>5034</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n\nSPY: Buy&Hold vs Stop vs Stop+VIX â€” metrics and exports\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nSaved strategy metrics to: figures/spy_strategy_comparison.csv\nSaved figure to: figures/spy_wealth_strategies.png\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![](06_stoploss_and_hedging_files/figure-pdf/strategy-comparison-output-3.pdf){#strategy-comparison-2 fig-pos='H'}\n:::\n:::\n\n\n",
    "supporting": [
      "06_stoploss_and_hedging_files/figure-pdf"
    ],
    "filters": []
  }
}