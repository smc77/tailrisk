{
  "hash": "5eace9d22c484cb6fbdcc6c68acbe7cd",
  "result": {
    "engine": "jupyter",
    "markdown": "# Early Warning Signals\n\nWe build features from price-only data (volatility ratio, drawdown slope, SMA deviation, and a lightweight LPPL risk score) and predict whether a large drawdown occurs within a forward horizon.\n\n::: {.cell execution_count=1}\n``` {.python .cell-code}\nimport pandas as pd, numpy as np, matplotlib.pyplot as plt\nfrom sklearn.linear_model import LogisticRegression\nfrom sklearn.metrics import roc_auc_score, roc_curve, classification_report\nfrom scripts.empirical_data import load_prices_yf\nfrom scripts.early_warnings import build_ews_features_from_prices, label_future_drawdown_from_prices\n\nspy = load_prices_yf(\"SPY\", start=\"2000-01-01\")\nX = build_ews_features_from_prices(spy)\ny = label_future_drawdown_from_prices(spy, horizon=60, threshold=-0.15)\n\ndf = pd.concat([X, y], axis=1).dropna()\nsplit = int(len(df)*0.7)\nX_train, X_test = df.iloc[:split, :-1], df.iloc[split:, :-1]\ny_train, y_test = df.iloc[:split, -1], df.iloc[split:, -1]\n\nclf = LogisticRegression(max_iter=2000)\nclf.fit(X_train, y_train)\nproba = clf.predict_proba(X_test)[:,1]\nauc = roc_auc_score(y_test, proba)\nprint(f\"AUC: {auc:.3f}\")\n\n# ROC\nfpr, tpr, _ = roc_curve(y_test, proba)\nplt.figure(); plt.plot(fpr, tpr, label=f\"AUC={auc:.3f}\"); plt.plot([0,1],[0,1],'k--')\nplt.xlabel(\"False Positive Rate\"); plt.ylabel(\"True Positive Rate\")\nplt.title(\"ROC â€” EWS with LPPL (SPY)\"); plt.legend(); plt.tight_layout(); plt.show()\n\n# Feature importances (coef magnitude)\nimp = pd.Series(clf.coef_[0], index=X.columns).sort_values(key=np.abs, ascending=False)\nprint(\"Top features:\\n\", imp.head(10))\n\n# Classification report at 0.5 threshold\npred = (proba >= 0.5).astype(int)\nprint(classification_report(y_test, pred, digits=3))\n\n# Export predictions\nout = pd.DataFrame({\"proba\": proba, \"y_test\": y_test.values}, index=y_test.index)\nout.to_csv(\"figures/ews_lppl_spy_predictions.csv\")\nprint(\"Saved predictions to figures/ews_lppl_spy_predictions.csv\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nTicker            SPY\nDate                 \n2000-01-03  92.142494\n2000-01-04  88.539185\n2000-01-05  88.697586\n2000-01-06  87.272102\n2000-01-07  92.340508\nAUC: 0.636\n```\n:::\n\n::: {.cell-output .cell-output-display}\n![SPY early-warning model with LPPL risk](05_early_warnings_files/figure-pdf/ews-lppl-spy-output-2.pdf){#ews-lppl-spy fig-pos='H'}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nTop features:\n sma_dev     -10.152640\nvol_ratio     0.399041\nlppl_risk    -0.094796\ndd_slope      0.080637\ndtype: float64\n              precision    recall  f1-score   support\n\n         0.0      0.886     0.997     0.938      1742\n         1.0      0.143     0.004     0.009       225\n\n    accuracy                          0.883      1967\n   macro avg      0.514     0.501     0.473      1967\nweighted avg      0.801     0.883     0.832      1967\n\nSaved predictions to figures/ews_lppl_spy_predictions.csv\n```\n:::\n:::\n\n\n",
    "supporting": [
      "05_early_warnings_files/figure-pdf"
    ],
    "filters": []
  }
}